<!DOCTYPE html>
<html>
    <head>
        <script src="cdom.js"></script>
    </head>
    <body>
        <div id="layoutroot"></div>
    </body>
</html>
<script>
function setResizer (container,framesMin,callback=()=>{}) {
    const p = container.dataset.proportion.split(":").map((x)=>{return Number(x);});
    const adj = 1/p.reduce((s,x)=>{return s+x},0);
    const percent = p.map((x)=>{return x*100*adj});
    for (const i in percent) {
        container.querySelectorAll(":scope > .resizer_content")[i].style.flexBasis = `${(percent[i])}%`;
    }
    container.dataset.proportion = percent.join(":");
    const type = container.dataset.type=="v";
    Array.from(container.querySelectorAll(":scope > .resizer_splitter")).map((splitter,i)=>{
        splitter.addEventListener("pointerdown",(e)=>{
            console.log(type)
            const rect = container.getBoundingClientRect();
            const rects = type?rect.height:rect.width;
            const rectx = type?rect.y:rect.x;
            const resizer = container.querySelector(":scope > .resizer_splitter").getBoundingClientRect();
            const resizerW = type?resizer.height:resizer.width;
            const resize1 = (e)=>{
                const ex = type?e.y:e.x;
                const percent = container.dataset.proportion.split(":").map((x)=>{return Number(x);});
                const width = rects - resizerW*(percent.length-1);
                const barprop = Math.min(Math.max((ex-rectx)/rects,0.01),0.99);
                const left = percent.slice(0,i+1);
                const right = percent.slice(i+1);
                const leftadj = left.reduce((s,x)=>{return s+x},0)==0?1:1/left.reduce((s,x)=>{return s+x},0);
                const rightadj = right.reduce((s,x)=>{return s+x},0)==0?1:1/right.reduce((s,x)=>{return s+x},0);
                const newpercent = left.map((x)=>{return x*barprop*leftadj*100}).concat(right.map((x)=>{return x*(1-barprop)*rightadj*100})).map((x)=>{return x<0.01?1:x;});
                container.dataset.proportion = newpercent.join(":");
                for (const i in newpercent) {
                    container.querySelectorAll(":scope > .resizer_content")[i].style.flexBasis = `${(newpercent[i])}%`;
                }
                callback();
            }
            const resize2 = (e)=>{
                const ex = type?e.y:e.x;
                const percent = container.dataset.proportion.split(":").map((x)=>{return Number(x);});
                const width = rects - resizerW*(percent.length-1);
                const left = percent.slice(0,i+1-1);
                const right = percent.slice(i+1+1);
                const min = left.reduce((s,x)=>{return s+x},0)*rects/100+resizerW*i;
                const max = rects - (right.reduce((s,x)=>{return s+x},0)*rects/100+resizerW*(percent.length-i-2));
                const newx = Math.min(Math.max(ex-rectx,min),max);
                if (max-newx<1|newx-min<1) {
                    resize1(e);callback();return;
                }
                const newpercent = [].concat(left,[(newx-min)*100/width],[(max-newx)*100/width],right);
                container.dataset.proportion = newpercent.join(":");
                for (const i in newpercent) {
                    container.querySelectorAll(":scope > .resizer_content")[i].style.flexBasis = `${(newpercent[i])}%`;
                }
                callback();
            }
            document.addEventListener("pointermove",resize2,false);
            document.addEventListener("pointerup",()=>{document.removeEventListener("pointermove",resize2,false);},false);
            e.target.setPointerCapture(e.pointerId);
        });
    })
}

function initlayout(dom) {
    dom.className = "layout_root";
    dom.replaceChildren(makeLayoutDOM(layout,"splitlayout"));
    dom.querySelectorAll(".resizer_container").forEach((x)=>{setResizer(x,50);})
}
function makeLayoutDOM(node,pid) {
    console.log(...node)
    var children = [];
    for (const i in node[2]) {
        if (node[2][i][0]=="h"||node[2][i][0]=="v") {
            children.push(elm("div",{class:"resizer_content"},[makeLayoutDOM(node[2][i],`${pid}_${i}`)]));
        }
        else if (node[2][i][0]=="c") {
            children.push(elm("div",{class:"resizer_content"},[contents[node[2][i][1]]()]));
            //children.push(contents[node[2][i][1]])
        }
        if (i<node[2].length-1) {
            children.push(elm("div",{class:"resizer_splitter"},[]));
        }
    }
    return elm("div",{data:{proportion:node[1].join(":"),id:pid,type:node[0]},class:`resizer_container`},children);
}



</script>
<script>

const layout = ["h",[3,5,4],[
    ["v",[4,8,3,4],[["c","text1"],["c","text2"],["c","text1"],["c","text2"]]],
    ["v",[4,8],[["c","text1"],["h",[4,8],[["c","text2"],["c","text1"]]]]],
    ["v",[4,8,4],[["c","text1"],["c","text2"],["c","text1"]]],
]]
const contents = {
    text1: ()=>{return elm("h1",{width:100,height:100},[textelm("やっほ～")])},
    text2: ()=>{return elm("h1",{width:100,height:100},[textelm("うごいたぞ～")])},
}
const KeyboardEvents = [
    {target:"img2",type:"keydown",key:"ctrl+c"},
]
initlayout(document.querySelector("#layoutroot"))

</script>
<style>
:root {
    color-scheme: dark;
    user-select: none;
}
body {
    margin: 0;
    padding: 0;
    height: 100dvh;
    width: 100dvw;
    overflow: hidden;
}
#layoutroot {
    height: 100%;
    width: 100%;
}


.layout_root {
    height: 100%;
    width: 100%;
}
.layout_root>div {
    height: calc(100% - 6px);
    width: calc(100% - 6px);
    padding: 3px;
}

h1 {
    padding: 5px;
    margin: 5px;
}

</style>
<style>
/* resizer */
.resizer_container[data-type="v"] {
    display: flex;
    flex-direction: column;
    height: 100%;
    & > .resizer_content {
        display: block;
        min-height: 0px;
        height: 100%;
        overflow: hidden;
        padding: 3px;
        border-radius: 5px;
        &:hover {
            box-shadow: 0px 0px 5px 0px white;
        }
    }
    & > .resizer_splitter {
        height: 5px;
        margin: 2px;
        width: calc(100% - 10px);
        border-radius: 3px;
        flex: none;
        cursor: row-resize;
        background-color: #7c7c7c;
    }
    & > .resizer_splitter:hover {
        background-color: #acacac;
    }
}
.resizer_container[data-type="h"] {
    display: flex;
    flex-direction: row;
    height: 100%;
    & > .resizer_content {
        display: block;
        min-width: 0px;
        width: 100%;
        overflow: hidden;
        padding: 3px;
        border-radius: 5px;
        &:hover {
            box-shadow: 0px 0px 5px 0px white;
        }
    }
    & > .resizer_splitter {
        width: 5px;
        margin: 2px;
        height: calc(100% - 10px);
        border-radius: 3px;
        flex: none;
        cursor: col-resize;
        background-color: #7c7c7c;
    }
    & > .resizer_splitter:hover {
        background-color: #acacac;
    }
}
</style>